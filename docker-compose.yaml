name: home

services:
  homeassistant:
    image: ghcr.io/home-assistant/home-assistant:latest
    container_name: homeassistant
    ports:
      - "8123:8123"
    # Running as host user for easier file permission management
    user: "${UID}:${GID}"
    # privileged removed; add back if you need USB / network discovery that fails without it
    environment:
      - TZ=America/Los_Angeles  # PST
    volumes:
      - ./data/homeassistant:/config  # entire HA config; manage via UI
      - /etc/localtime:/etc/localtime:ro
    restart: unless-stopped
    depends_on:
      - mosquitto
  # Caddy (reverse proxy) is optional and starts after HA

  mosquitto:
    image: eclipse-mosquitto:latest
    container_name: mosquitto
    ports:
      - "1883:1883"
      - "9001:9001"  # websockets (optional)
    user: "${UID}:${GID}"
    volumes:
      - ./config/mosquitto/mosquitto.conf:/mosquitto/config/mosquitto.conf:ro
      - ./data/mosquitto/data:/mosquitto/data
      - ./data/mosquitto/log:/mosquitto/log
    restart: unless-stopped

  caddy:
    image: caddy:2-alpine
    container_name: caddy
    ports:
      - "80:80"
      - "443:443"
    environment:
      - ACME_AGREE=true
    volumes:
      - ./config/caddy/Caddyfile:/etc/caddy/Caddyfile:ro
      - caddy_data:/data
      - caddy_config:/config
    depends_on:
      - homeassistant
      - your-service  # Add dependency on your new service
    restart: unless-stopped

  # New service for schniff.snek2.ddns.net
  # Replace this with your actual service configuration
  your-service:
    image: nginx:alpine  # Replace with your desired image
    container_name: your-service
    # ports:  # No need to expose ports externally since we're using reverse proxy
    #   - "8080:80"  # Only uncomment if you need direct access for testing
    volumes:
      - ./data/your-service:/usr/share/nginx/html:ro  # Replace with your volume mounts
    environment:
      - TZ=America/Los_Angeles
    restart: unless-stopped

volumes:
  caddy_data: {}
  caddy_config: {}
