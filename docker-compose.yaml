name: home

services:
  homeassistant:
    image: ghcr.io/home-assistant/home-assistant:latest
    container_name: homeassistant
    ports:
      - "8123:8123"
    # Running as host user for easier file permission management
    user: "${UID}:${GID}"
    # privileged removed; add back if you need USB / network discovery that fails without it
    environment:
      - TZ=America/Los_Angeles  # PST
    volumes:
      - ./data/homeassistant:/config  # entire HA config; manage via UI
      - /etc/localtime:/etc/localtime:ro
    restart: unless-stopped
    depends_on:
      - mosquitto
  # Caddy (reverse proxy) is optional and starts after HA

  mosquitto:
    image: eclipse-mosquitto:latest
    container_name: mosquitto
    ports:
      - "1883:1883"
      - "9001:9001"  # websockets (optional)
    user: "${UID}:${GID}"
    volumes:
      - ./config/mosquitto/mosquitto.conf:/mosquitto/config/mosquitto.conf:ro
      - ./data/mosquitto/data:/mosquitto/data
      - ./data/mosquitto/log:/mosquitto/log
    restart: unless-stopped

  caddy:
    image: caddy:2-alpine
    container_name: caddy
    ports:
      - "80:80"
      - "443:443"
    environment:
      - ACME_AGREE=true
      - ESPHOME_USERNAME=${ESPHOME_USERNAME}
      - ESPHOME_PASSWORD=${ESPHOME_PASSWORD}
    volumes:
      - ./config/caddy/Caddyfile:/etc/caddy/Caddyfile:ro
      - caddy_data:/data
      - caddy_config:/config
    depends_on:
      - homeassistant
    restart: unless-stopped
    networks:
      - home_default

  noip:
    image: ghcr.io/noipcom/noip-duc:latest
    container_name: noip-updater
    environment:
      - NOIP_USERNAME=${NOIP_USERNAME}
      - NOIP_PASSWORD=${NOIP_PASSWORD}
      - NOIP_HOSTNAMES=${NOIP_DOMAINS}
    network_mode: host
    restart: unless-stopped

  esphome:
    image: esphome/esphome:latest
    container_name: esphome
    volumes:
      - ./data/esphome:/config
      - /etc/localtime:/etc/localtime:ro
    environment:
      - TZ=America/Los_Angeles
      - PLATFORMIO_CORE_DIR=/config/.esphome/platformio
    ports:
      - "6052:6052"  # ESPHome dashboard
      - "6123:6123"  # OTA updates
    restart: unless-stopped
    networks:
      - home_default
    user: "${UID}:${GID}"

  palworld:
    image: thijsvanloef/palworld-server-docker:latest
    container_name: palworld
    restart: unless-stopped
    ports:
      - "8211:8211/udp"
      - "27015:27015/udp"
    environment:
      - PUID=${UID}
      - PGID=${GID}
      - PORT=8211
      - PLAYERS=16
      - MULTITHREADING=true
      - RCON_ENABLED=true
      - RCON_PORT=25575
      - TZ=America/Los_Angeles
      - COMMUNITY=true
      - SERVER_NAME=Nog Island
      - SERVER_PASSWORD=squirt
      - ADMIN_PASSWORD=${PALWORLD_ADMIN_PASSWORD}
      - PUBLIC_IP=pal.snek2.ddns.net
      - PUBLIC_PORT=8211
    volumes:
      - ./data/palworld:/palworld
    networks:
      - home_default

volumes:
  caddy_data: {}
  caddy_config: {}

networks:
  home_default:
    external: true

